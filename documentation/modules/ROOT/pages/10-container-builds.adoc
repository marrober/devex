= The Container Build Process
:navtitle: The ContainerBuild Process
:source-highlighter: rouge

image::10-01-container-build-process.png[Container Build Process,600,align="center"]

== The Container Build Process

====
*What will you learn?*

This module will introduce you to the concepts of creating new container images.

This module will also cover the use of Podman to push container images to external registries.

After completing the module you will understand how to create, run and manage container images.
====

=== *Pre-Requisites*

In order to undertake the module you need to be logged onto the cluster and have access to a project.

Ensure that the two text boxes at the top of page contain the Cluster address provided by the workshop facilitators and the project you have been assigned. Remember to press *RETURN* after entering text into each field.

This module requires the use of a Podman executable that is not installed in the web terminal that you have used so far. Rather than ask you to install additional software on yor machine, we have made Podman (and other executables you need) available in a new container image that you can run in your project. Once this container is running you can open a terminal to it and execute the required commands.

== Introducing Podman

Podman is a command line utility for the creation, execution and management of container images. Podman can be used to execute a dockerfile to construct a new container which will be held locally once created. The container image can then be executed locally for initial testing before being pushed to a container registry for storage such that it can be used by other systems. Podman is an open source project that is free to use and further information can be found https://podman.io[here].

The podman command contains a number of sub commands for the various operations that it can perform. To see the full list of commands simply execute 'podman --help' in the new terminal window. This will show a set of sub-commands. To see the details of how to use a specific sub-command (for example the 'create' command) use 'podman create --help'.

== Setting up the new terminal

The container image for the new terminal is available quay.io/marrober/devex-podman:LATEST[here]. Feel free to go to this location in a browser to take a look at the image repository.

To use the image you need to create a new deployment from a container image usng the following steps.

Switch to the developer context and select the topology view. Copy the text from below and then press the + symbol next to the >_ terminal icon that you have used before. Paste the cotnent from below into the window that is displayed and press create.

[.console-input]
[source,bash,subs="+attributes"]
----
apiVersion: v1
kind: Pod
metadata:
  name: podman
  labels:
    app: podman
spec:
  containers:
  - name: podman
    image: quay.io/marrober/devex-podman:LATEST
    args:
      - sleep
      - "1000000"
    securityContext:
      privileged: true
---
apiVersion: v1
kind: Service
metadata:
  name: podman-svc
  labels:
    app: podman
spec:
  ports:
  - name: http
    port: 8080
  selector:
    app: podman
---
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  labels:
    app: podman
  name: podman-route
spec:
  to:
    kind: Service
    name: podman-svc
----

This is a new way to create resources and can be useful when you have a block of yaml content that you need to use. Alternatively then content could be saved to a file and executed using the 'oc apply -f <filename>' command.

Dismiss the information panel that tells you that the pod, service and route have been created. You will then see the following view of the new pod which is shown with the right hand side context menu displayed.

image::10-02-podman-pod.png[Podman pod,800,align="center"]

Click on the pod to display the right hand side menu and then select the resources tab.

Right-click on the route and select 'open in new browser tab'. You will see that this shows that nothing is currently running on the assigned port. The application will exist shortly as soon as you have created the container image using Podman and run the container using Podman.

Switch back to the previous browser tab and click on the pod called 'podman' on the right hand side menu.

Select the terminal from the context menu. This will display a Linux terminal in which you will perform the following Podman operations.

== Introducing Container Creation

A container is created from a dockerfile. The dockerfile is a text document that consists of a series of commands to add content and configure the container image. The commands begin with a 'FROM' command that indicates the container from which the new container will be constructed. Subsequent commands may include:

* *RUN* - To run a command within the container such as installing a new binary with dnf or yum.
* *EXPOSE* - To expose a port from within the container to the external environment.
* *USER* - Specify the user ID to be used to run the subsequent commands. It is best to run container images as a non-root user whenever possible. However, during installation processes it is often best to set the root user, then install applications, and then switch to a lower user for the execution of the command that will be used to run the container.
* *ADD* - To add files to the container image filesystem from either the local filesystem or a URL. If a tar file is specified from the local filesystem then the file will be expanded within the container filesystem automatically.
* *COPY* - To copy files in to the container image filesystem from the local filesystem only.
* *ENTRYPOINT* - The command to run when the container is started.
* *CMD* - Command line arguments to the above command.

=== Getting the required dockerfile and application

The content you require for the next steps is in a git repository. You need to clone the repository to the running Podman pod with the following command :

[.console-input]
[source,bash,subs="+attributes"]
----
git clone https://github.com/marrober/devex.git
----

Change directory to the repository content and then switch to the container-build directory. Take a look at the content in the directory. The location contains the Node.JS source code, a package file that contains a list of dependencies and the dockerfile.

[.console-input]
[source,bash,subs="+attributes"]
----
cd devex/container-build/
ls
----

You don't need to know this language at all to perform the following steps but you can take a look at the file called layer.js if you want to. In order to run the application you need to download to the location a number of dependencies. To do this execute the following command.

[.console-input]
[source,bash,subs="+attributes"]
----
npm install
----

Take another look at the content in the directory and you will see that a package-lock.json file and a directory called node_modules have been created.

=== Example dockerfile

The process that you are about to perform includes the use of the following dockerfile.

[source]
----
FROM quay.io/marrober/rhel8-nodejs-14:latest
COPY layer.js /opt/app-root/src/layer.js
COPY node_modules/ /opt/app-root/src/node_modules/
USER 0
RUN chmod a+w /var/log
USER 1001
EXPOSE 8080
ENTRYPOINT ["node"]
CMD ["/opt/app-root/src/layer.js",  "> /var/log/output.log &"]
----

Now that you have seen the content of the application files, the dockerfile will make more sense. The lines of the dockerfile will perform the follwowing tasks.

* *FROM*       - Use this container image as the starting point for the new container.
* *COPY*       - The two lines will copy the source file to be executed and the node modules to specific locations within the container.
* *USER*       - Elevate permissions for the next step.
* *RUN*        - Execute the chmod command to add write permissions for everyone to the /var/log location.
* *USER*       - Drop the user permissions back down to an ordinary user.
* *EXPOSE*     - Expose the port on which the Node.JS application will listen for requests.
* *ENTRYPOINT* - The application to run within the container.
* *CMD*        - The arguments to the command above.

=== Building the container image

Before you build the container list the images present.

[.console-input]
[source,bash,subs="+attributes"]
----
podman images
----

Use the following command to build the container image and give it the specific name my-container with a tag (version) of 1.

[.console-input]
[source,bash,subs="+attributes"]
----
podman build -f dockerfile -t my-container:1
----

List the images present again to confirm that it was created.
